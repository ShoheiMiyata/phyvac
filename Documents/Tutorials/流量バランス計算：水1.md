## 流量バランス計算：AHU1台、Chiller3台  
システム図（左：元の構成→右：流量バランス計算のために枝の数が少なくなるようBranchを定義）  
<img src="https://user-images.githubusercontent.com/27459538/112748524-16f85680-8ff7-11eb-8d1e-9e9522691558.png" width=80%>

  
## コード例 - FlowBalance1AHU_3Chillers.py
コード全体は[こちら](https://github.com/ShoheiMiyata/phyvac/tree/main/MainSample/1AHP_simpleAHU/miyata)にアップロードされています。  
  
まず最初に、phyvacをインポートします。
```
import phyvac as pv
``` 
### 機器の定義
`AHU`:air handling units, `Vlv_AHU`: AHU用の弁, `CP1`: Chiller1用の冷水ポンプ  
モジュールの初期値が対象機器において不適切な場合、特性パラメータを適宜入力します。ここでは簡略のためChillerモジュールは使いません。
```
# 機器の定義
AHU1 = pv.AHU_simple(kr=2.0)
Vlv_AHU = pv.Valve(cv_max=800,r=100)
CP1 = pv.Pump(pg=[233.9,5.9578,-4.460], eg=[0.009964,0.4174,-0.0508])
CP2 = pv.Pump(pg=[233.9,5.9578,-4.460], eg=[0.009964,0.4174,-0.0508])
CP3 = pv.Pump(pg=[233.9,5.9578,-4.460], eg=[0.009964,0.4174,-0.0508])
```
### 枝の定義  
下図の配管ループは2つの枝（branch）とみなすことができます。 `Branch_aAHUb`が点aからAHUを通り点bまで、`Branch_bChiller1a`が点bからChiller1を通り点aまでの枝に分けられます。  
流量バランス計算を行うためには、運転時に常に流量が生じる枝(`Branch_aAHUb`)を設定する必要があります。これは配管網が複雑になっても同様です。 
```
# 枝の定義
Branch_aAHUb = pv.Branch01(Vlv_AHU, kr_eq=AHU1.kr, kr_pipe=3.0)
Branch_bChiller1a = pv.Branch10(pump=CP1, kr_eq=10.0, kr_pipe=7.0)
Branch_bChiller2a = pv.Branch10(pump=CP2, kr_eq=10.0, kr_pipe=7.0)
Branch_bChiller3a = pv.Branch10(pump=CP3, kr_eq=10.0, kr_pipe=7.0)
```
### 弁開度・ポンプinvの入力
ここでは制御を省いているため、手動で弁開度とポンプinvを入力します。制御機器の状態から、流量が全て算出される点が流量バランス計算の特徴です。  
`Vlv_AHU.vlv`: Vlv_AHUの弁開度。0が全閉、1が全開, `CP1.inv`: CP1のinv周波数比。0が停止、1が定格値（関東だと60Hz）  
```
Vlv_AHU.vlv = 0.7
CP1.inv = 0.7
CP2.inv = 0.7
CP3.inv = 0.7
```
### 流量バランス計算  
まず、運転時に流量が常に生じる枝(`Branch_aAHUb`)の最小流量(`g_min = 0.0`)と最大流量(`g_max = 0.5`)を設定します。また、収束判定用の変数に適当な値を与えます(`g_eva = 0.5`)。  
while文では、まず最初に`Branch_aAHUb`用の流量を仮定します(`g = (g_max + g_min) / 2`, 平均をとるゆえに二分法と呼ばれます)。次に、点aと点bの差圧を算出します(`dp1 = Branch_aAHUb.f2p(g)`)。そして、`Branch_bAHP1a`の流量を先ほど得られた`dp1`から算出します(`Branch_bAHP1a.p2f(-dp1)`)。  
収束判定用の変数`g_eva`は、`Branch_aAHUb`と`Branch_bASHP1a`の流量の差です。`g_eva`が0より大きい場合、`g_max`を再設定し、そうでない場合は`g_min`を再設定します。  
```
        g_min = 0.0
        g_max = 0.5
        g_eva = 0.5
        cnt = 0
        while (g_eva > 0.001) or (g_eva < -0.001):
            cnt += 1
            g = (g_max + g_min) / 2
            dp1 = Branch_aAHUb.f2p(g)
            Branch_bAHP1a.p2f(-dp1)
            g_eva = Branch_aAHUb.g - Branch_bASHP1a.g
            if g_eva > 0:
                g_max = g
            else:
                g_min = g
            if cnt > 30:
                break
```
流量バランス計算でおこなっていることは以下のようにまとめられます。  
1. まず、ある枝の流量を仮定し、仮定した流量に基づきその枝の差圧を算出する  
2. その他の枝で、1.の差圧に基づき流量を算出する  
3. 1.で仮定した流量と、2.で算出された流量が等しくなるまで収束計算する  
  
この方法は配管網が複雑になっても適用が可能です。
### 温度と消費電力計算  
`AHU_0`と`ASHP1_0`は機器の変数値を前時刻の値として格納します。このプログラムでは、機器の入口温度は前時刻の他の機器の出口温度を参照します。
```
    AHU_0 = copy.deepcopy(AHU)
    ASHP1_0 = copy.deepcopy(AHP1)
    AHU.cal(g=Vlv_AHU.g, tin=ASHP1_0.tout_ch, q_load=q_load)
    ASHP1.cal(tout_ch_sv=t_supply_sv, tin_ch=AHU_0.tout, g_ch=CP1.g, tdb=tdb)
    CP1.cal()
```
データフレームに計算結果を書き込みます。
```
    output_data.iloc[calstep] = np.array([[g_load, AHU.g, AHU.tin, AHU.tout, Vlv_AHU.vlv, -Branch_aAHUb.dp, CP1.g, CP1.inv, CP1.pw, CP1.dp, CP1.ef,
                                           ASHP1.g_ch, ASHP1.tin_ch, ASHP1.tout_ch, ASHP1.cop, ASHP1.pw, ASHP1.pl, tdb]])
    
    current_time += datetime.timedelta(minutes=1)
```
### シミュレーション結果の保存
```
output_data = output_data.resample('15min').mean()
output_data.to_csv('result_15min.csv')
```

